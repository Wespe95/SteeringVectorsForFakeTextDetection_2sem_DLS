#%% md
# Fake Text Detection with Steering Vectors (with Llama-2, Phi-2, Falcon 3-7B-Base):
 
- Фейковые и реальные тексты для построения стиринг векторов взяты из COLING (https://huggingface.co/datasets/Jinyan1/COLING_2025_MGT_en). 
- Для активаций и стиринг-векторов были построены графики магнитуды, косинусного подобия от слоя к слою, heatmap усреднённого стиринг-вектора, а также T-SNE, PCA и UMAP каждого слоя относительно меток и график дисперсии классов по слоям.
- Для задачи детектирования фейковых текстов использовался домен reddit — тренировочное и тестовое множества. Из активаций слоёв и стиринг-векторов были посчитаны проекции "фейковости" и обучены три классификатора: логистическая регрессия, random forest и SVM.
- Для каждого классификатора построены графики и рассчитаны основные метрики. Классификаторы обучались на каждом слое, чтобы выяснить, какая активация какого слоя лучше всего подходит для детекции фейковых текстов.
- Аналогичный анализ проведён для задачи переноса: классификаторы обучались на стиринг-векторах одного домена (reddit) и тестировались на других доменах (financial, medical). Выбор этих доменов обусловлен их спецификой: финансовые и медицинские тексты имеют строгую структуру и терминологию, что усложняет детекцию фейковости — здесь креативность неуместна, и как человеку, так и модели приходится придерживаться определённого стиля и стандартов.
- Для лучшего понимания проведенных экспериментов советую сначала посмотреть на эксперимента с Llama-2, потом с Microsoft/Phi-2 и после этого Falcon 3-7B-Base.
---

## Структура проекта:

    SteeringVectorsForFakeTextDetection_2sem_DLS/
    ├── .gitignore
    ├── README.md
    ├── requirements.txt
    └── Projekt/
        ├── compute_projection/ # Scripts for calculating the projections
        ├── compute_steering_vectors/ # Scripts for calculating the steering vectors
        ├── computed_projection_data/ # Calculated projection results (link to Google Drive)
        ├── computed_steering_data/ # Calculated steering vectors (link to Google Drive)
        ├── notebooks/
        │   ├── FakeTextDetectionWithSteering_llama.ipynb   # the first experiment with the Llama-2 model.
        │   ├── FakeTextDetectionWithSteering_phi2.ipynb    # the second experiment with the Microsoft/Phi-2 model
        │   └── FakeTextDetectionWithSteering_falcon3.ipynb # the third experiment with the Falcon3-7B-Base model
        ├── visualize_computed_steering_vectors/ # Scripts for visualising the steering vectors
        └── visualized_data_from_steering_vectors/ # Calculated visualisations (link to Google Drive)


---

## Сравнительный анализ представления концепта "фейковости" в слоях LLM (Llama-2, Phi-2, Falcon 3-7B-Base)

В этом проекте исследуется, как различные архитектуры современных языковых моделей (Llama-2, Phi-2, Falcon 3-7B-Base) формируют и обрабатывают концепт "фейковости" на уровне активаций. 
Анализ проводится как на исходных данных (сохранение домена), так и при переносе на специализированные домены (финансовый, медицинский).

### Ключевые выводы по моделям

#### Llama-2
- **Формирование концепта:** Ключевая информация о "фейковости" впервые появляется примерно на 13-м слое и далее усиливается. Максимальный вклад в детекцию дают слои 13–20.
- **Влияние домена:** При переносе на финансовый и медицинский домены значимость этих слоёв снижается, а решающую роль начинают играть более поздние слои. Это указывает на доменно-специфическую структуру концепта и подтверждает, что "фейковость" — контекстно-зависимый признак.
- **Динамика метрик:** Классификаторы достигают стабильных и высоких результатов уже с 13-го слоя, но при смене домена лучшие метрики смещаются к концу модели.

#### Phi-2
- **Формирование концепта:** В отличие от llama, phi-2 начинает различать "фейковость" уже с первых слоёв; первый слой даёт высокий вклад в детекцию (accuracy > 0.85).
- **Структура активаций:** Большинство слоёв ведут себя схоже, за исключением скачка в 29-м слое. Активируются преимущественно положительные и нейтральные компоненты.
- **Кластеризация:** t-SNE и PCA показывают хорошую кластеризацию, но с иной структурой, чем у llama. Внутриклассовая дисперсия по слоям выше.
- **Динамика метрик:** Лучшие показатели точности и F1 достигаются на последних слоях (26–29), что связано с меньшей размерностью phi-2.
- **Влияние домена:** При переносе на специализированные задачи вклад начальных слоёв быстро падает, но уже после 5-го слоя обучение стабилизируется, а лучшие метрики достигаются на более ранних слоях (около 17-го).

#### Falcon 3-7B-Base
- **Формирование концепта:** Модель сочетает черты llama-2 и phi-2, но демонстрирует собственную специфику: несколько выраженных скачков по слоям (18–19, 20–21, 25–26, 27–28) указывают на поэтапное формирование концепта.
- **Структура активаций:** Steering-векторы Falcon характеризуются преобладанием подавленных и нейтральных активаций, положительных очень мало.
- **Кластеризация:** Чёткая кластеризация текстов появляется только после 5-го слоя (PCA, t-SNE), а корреляционный анализ выявляет две зоны сильной положительной корреляции между слоями (3–17 и 20–27).
- **Динамика метрик:** Все классификаторы показывают стабильный рост метрик по слоям, а логистическая регрессия даёт наилучшую стабильность. После 5-го слоя метрики стабильно высоки до конца сети.
- **Влияние архитектуры:** Для высокой чувствительности к "фейковости" Falcon не требует синтетических данных — архитектура и разнообразие обучающих данных оказывают ключевое влияние.
- **Влияние домена:** При переносе на другие домены первые слои теряют значимость, обучение быстро стабилизируется, а лучшие метрики достигаются на последних слоях (25–27).

### Итоговый вывод

**Во всех моделях концепт "фейковости" формируется многоступенчато и нестатично:**  
- В llama-2 и Falcon ключевая информация появляется в середине сети, у phi-2 — с самого начала.
- Перенос на специализированные домены вызывает смещение значимых слоёв к концу или середине модели.
- При переносе домена часть слоев становится менее чувствительна к концепту "фейковости". Данное поведение было замечено у всех трех моделей. На этом основании была выдвинута гипотеза о неоднородности концепта "фейковость".
- Архитектурные особенности и разнообразие обучающих данных существенно влияют на чувствительность и структуру представления концепта.

**Практический вывод:**  
Для задач детекции "фейковости" важно учитывать не только архитектуру модели, но и специфику обучающих данных и целевого домена. 
Разные модели формируют внутренние представления по-разному, что влияет на переносимость и качество решений в реальных задачах.
Однозначно можно скачать, что Steering Vectors подходят для задачи детектирования текстов не хуже эмбеддингов и определенные слои улавливают этот концепт по-разному хорошо, зависит от модели.

Для будущего анализа можно посмотреть, как ведет себя та или иная модель, если Steering Vectors будут вычислены на одном множестве доменов и перенос будет сделан на другое множество доменов.
Более того, интересно посмотреть в будущих экспериментах, как модель/модели будет/будут реагировать на манипулированные тексты.
